<!DOCTYPE html>
<html>
<head>
    <title>Evolution Patterns</title></head>
    <script src="jquery-3.5.1.min.js"></script>
    <script src="papaparse.min.js"></script>
    <style>
        body {
            overflow-wrap: anywhere;
        }
        .row {
            overflow: anywhere;
        }
        .container {
            display: flex;
            flex-direction: row;
        }
        .name {
            width: 90%;
            margin: 2px;
            overflow-wrap: anywhere;
        }
        .type {
            width: 5%;
            margin: 2px;
        }
        .showBtnContainer {
            width: 5%;
        }
        #evolutionList {
            top: 0;
            left: 0;
            bottom:0;
            right: 0;
            padding: 3%;
            position: fixed;
            width: 100%;
            display: none;
            overflow-y:scroll;
            background-color: aliceblue;
        }
        #evolutionList .key {
            width: 10%;
        }
        #evolutionList .value {
            width: 80%;
        }
        #closeBtn {
            padding: 10px;
            width: 10%;
            background-color: red;
        }
        xmp{ white-space:pre-wrap; word-wrap:break-word; }
        .lastclick {
            color: red;
            background-color: black;
        }

        .DISABLED {
            background-color: bisque;
        }
        .RE-ENABLED {
            background-color:aquamarine;
        }
        .NotInStudyDuration {
            background-color: grey;
        }
        .DELETED {
            background-color: plum;
        }
    </style>
<body>
    <input type="file" id="data" webkitdirectory directory multiple/><input type="button" id="loaddata" value="start" />
    <div id="list">
        <div class="row container">
            <div class="name">Name</div>
            <div class="type">Evolution</div>
        </div>
    </div>
    <div id="evolutionList">
        <div id="closeBtn">Close X</div>
        <div id="items">
        </div>
    </div>
    <script>
        $("#loaddata").click(function() {
            var files = $("#data")[0].files;
            var data = {};
            var evolutionMap = {};
            project_repo = {
                "camel": "https://github.com/apache/camel/commit/",
                "cassandra": "https://github.com/apache/cassandra/commit/",
                "cloudstack": "https://github.com/apache/cloudstack/commit/",
                "druid": "https://github.com/apache/druid/commit/",
                "flink": "https://github.com/apache/flink/commit/",
                "hadoop": "https://github.com/apache/hadoop/commit/",
                "hbase": "https://github.com/apache/hbase/commit/",
                "hive": "https://github.com/apache/hive/commit/",
                "ignite": "https://github.com/apache/ignite/commit/",
                "incubator-pinot": "https://github.com/apache/incubator-pinot/commit/",
                "kafka": "https://github.com/apache/kafka/commit/",
                "maven": "https://github.com/apache/maven/commit/",
                "orientdb": "https://github.com/orientechnologies/orientdb/commit/",
                "storm": "https://github.com/apache/storm/commit/",
                "Openfire": "https://github.com/igniterealtime/Openfire/commit/"
            }
            let csv;
            for (let i = 0; i < files.length; i++) {
                const f = files[i];
                if (f.name.endsWith(".csv")) {
                    csv = f;
                    break;
                }
            }
            Papa.parse(csv, {complete: function(results) {
                for (let j = 1; j < results.data.length; j++) {
                    const row = results.data[j];
                    if (row[0] === "") {
                        continue;
                    }
                    var tr = document.createElement("div");
                    tr.setAttribute("class", "row container")
                    var td1 = document.createElement("div");
                    td1.setAttribute("class", "name");
                    var textNodeContainer = document.createElement("div");
                    td1.appendChild(document.createTextNode(row[0]));
                    var td2 = document.createElement("div");
                    td2.setAttribute("class", "type");
                    var commits = row[2].split("->");
                    var types = row[1].split("->");

                    if (commits.length != types.length) {
                        alert("something is wrong :(");
                    }

                    var typesText = types.join("\n    |\n    v\n");
                    var pre = document.createElement("pre");
                    pre.appendChild(document.createTextNode(typesText));
                    td2.append(pre);

                    var td3 = document.createElement("div");
                    var btn = document.createElement("button");
                    btn.textContent = "Show Details";
                    td3.setAttribute("class", "showBtnContainer");
                    btn.setAttribute("name", row[0]);
                    btn.setAttribute("class", row[0].replaceAll(".", "_").replaceAll("(", "lp").replaceAll(")", "rp").replaceAll("::", "__") + " " + "show");
                    td3.append(btn);
                    tr.append(td1, td2, td3);
                    $("#list").append(tr);
                    $("#list").append("<hr/>")
                    evolutionMap[row[0]] =  row;
                }
                for (let i = 0; i < files.length; i++) {
                    const f = files[i];
                    if (f.name.endsWith(".json")) {
                        var reader = new FileReader();
                        reader.readAsText(f);
                        reader.onload = (function(f){
                            var project = f.name.split("@")[0];
                            return function (event) {
                                var json = JSON.parse(event.target.result);
                                for (let i = 1; i < results.data.length; i++) {
                                    const sample = results.data[i];
                                    if (sample[0] in json) {
                                        data[sample[0]] = json[sample[0]];
                                        data[sample[0]]["project"] = project;
                                        for (let index = 0; index < data[sample[0]].length; index++) {
                                            const state = data[sample[0]][index];
                                            state["project"] = project;
                                        }
                                    }
                                }
                            };
                        })(f); 
                    }
                }
            }});
            function createContainer(text, value, valueNode = "div") {
                var container = document.createElement("div");
                container.setAttribute("class", "container");
                var key = document.createElement("div");
                key.textContent = text;
                key.setAttribute("class", "key");
                container.append(key);
                var val = document.createElement(valueNode);
                if (valueNode === "a") {
                    val.setAttribute("href", value);
                    val.setAttribute("target", "_blank")
                }
                val.textContent = value;
                val.setAttribute("class", "value");
                container.append(val);
                return container;
            }
            function createItem(state, kls) {
                var name = createContainer("Name: ", state["name"]);
                var filepath = createContainer("FilePath: ", state["filePath"]);
                var commit = createContainer("Commit: ", project_repo[state["project"]] + state["commitId"], "a");
                var change = createContainer("Change: ", kls === "None" && state["status"] === "DEL" ? "deleted" : kls);
                var activeAnnotations = createContainer("ActiveAnnotations: ", state["activeAnnotations"]);
                var COAnnotations = createContainer("COAnnotations: ", state["COAnnotations"]);
                var status = createContainer("Status: ", state["status"]);
                var content = createContainer("Content: ", state["content"], "xmp");
                var item = document.createElement("div");
                item.setAttribute("class", kls)
                item.append(name, change, filepath, commit, activeAnnotations, COAnnotations, status, content);
                return item;
            }
            $(document).on("click", "button.show", function(e) {
                var btn = e.currentTarget;
                var row = evolutionMap[btn.getAttribute("name")];
                var commits = row[2].split("->");
                var types = row[1].split("->");
                $("#items").empty();
                for (let i = 0; i < data[btn.getAttribute("name")].length; i++) {
                    const state = data[btn.getAttribute("name")][i];
                    const index = commits.indexOf(state["commitId"]);
                    if (index != -1) {
                        $("#items").append(createItem(data[btn.getAttribute("name")][i], types[index]));
                    } else if (i == 0) {
                        $("#items").append(createItem(data[btn.getAttribute("name")][i], "First-Node-Just-For-Comparison"));
                    }
                }
                $("#evolutionList").show();
                $(btn)[0].setAttribute("class", $(btn)[0].getAttribute("class") + " lastclick");
            });
            $("#closeBtn").click(function() {
                $("#evolutionList").hide();
            });
        });
        $(document).ready(function() {
            alert("Note: put the manual study file (*.csv) and the 15 json files to a single folder. Click choose files, choose your folder in the popup dialog. Then click start button. All the analysis are at the front end. No files will be uploaded."); 
        });
    </script>
</body>
</html>