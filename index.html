<!DOCTYPE html>
<html>
<head>
    <title>Evolution Patterns</title></head>
    <script src="jquery-3.5.1.min.js"></script>
    <script src="papaparse.min.js"></script>
    <style>
        body {
            overflow-wrap: anywhere;
        }
        .row {
            overflow: anywhere;
        }
        .container {
            display: flex;
            flex-direction: row;
        }
        .name {
            width: 90%;
            margin: 2px;
            overflow-wrap: anywhere;
        }
        .type {
            width: 10%;
            margin: 2px;
        }
        #item {
            top: 0;
            left: 0;
            bottom:0;
            right: 0;
            padding: 3%;
            position: fixed;
            width: 100%;
            display: none;
            overflow-y:scroll;
            background-color: aliceblue;
        }
        #item .key {
            width: 10%;
        }
        #item .value {
            width: 80%;
        }
        #closeBtn {
            padding: 10px;
            width: 10%;
            background-color: red;
        }
        xmp{ white-space:pre-wrap; word-wrap:break-word; }
        .lastclick {
            color: red;
            background-color: black;
        }
    </style>
<body>
    <input type="file" id="data" webkitdirectory directory multiple/><input type="button" id="loaddata" value="start" />
    <div id="list">
        <div class="row container">
            <div class="name">Name</div>
            <div class="type">Evolution</div>
        </div>
    </div>
    <div id="item">
        <div id="closeBtn">Close X</div>
        <div class="container">
            <div class="key">Name: </div>
            <div class="value" id="name"></div>
        </div>
        <div class="container">
            <div class="key">Filepath: </div>
            <div class="value" id="filepath"></div>
        </div>
        <p id="commit"></p>
        <div class="container">
            <div class="key">liveAnnotations: </div>
            <div class="value" id="liveAnnotations"></div>
        </div>
        <div class="container">
            <div class="key">COAnnotations: </div>
            <div class="value" id="COAnnotations"></div>
        </div>
        <div class="container">
            <div class="key">status: </div>
            <div class="value" id="status"></div>
        </div>
        <div class="container">
            <div class="key">content: </div>
            <div class="value" id="content"></div>
        </div>
    </div>
    <script>
        $("#loaddata").click(function() {
            var files = $("#data")[0].files;
            var data = {};
            project_repo = {
                "camel": "https://github.com/apache/camel/commit/",
                "cassandra": "https://github.com/apache/cassandra/commit/",
                "cloudstack": "https://github.com/apache/cloudstack/commit/",
                "druid": "https://github.com/apache/druid/commit/",
                "flink": "https://github.com/apache/flink/commit/",
                "hadoop": "https://github.com/apache/hadoop/commit/",
                "hbase": "https://github.com/apache/hbase/commit/",
                "hive": "https://github.com/apache/hive/commit/",
                "ignite": "https://github.com/apache/ignite/commit/",
                "incubator-pinot": "https://github.com/apache/incubator-pinot/commit/",
                "kafka": "https://github.com/apache/kafka/commit/",
                "maven": "https://github.com/apache/maven/commit/",
                "orientdb": "https://github.com/orientechnologies/orientdb/commit/",
                "storm": "https://github.com/apache/storm/commit/",
                "Openfire": "https://github.com/igniterealtime/Openfire/commit/"
            }
            let csv;
            for (let i = 0; i < files.length; i++) {
                const f = files[i];
                if (f.name.endsWith(".csv")) {
                    csv = f;
                    break;
                }
            }
            Papa.parse(csv, {complete: function(results) {
                for (let j = 1; j < results.data.length; j++) {
                    const row = results.data[j];
                    var tr = document.createElement("div");
                    tr.setAttribute("class", "row container")
                    var td1 = document.createElement("div");
                    td1.setAttribute("class", "name");
                    var textNodeContainer = document.createElement("div");
                    td1.appendChild(document.createTextNode(row[0]));
                    var td2 = document.createElement("div");
                    td2.setAttribute("class", "type");
                    
                    var commits = row[1].split("->");
                    var types = row[2].split("->");

                    if (commits.length != types.length) {
                        alert("something is wrong :(");
                    }

                    for (let j = 0; j < commits.length; j++) {
                        const commitId = commits[j];
                        const type = types[j];
                        var btn = document.createElement("button");
                        btn.setAttribute("commit", commitId);
                        btn.setAttribute("name", row[0]);
                        btn.setAttribute("class", row[0].replaceAll(".", "_").replaceAll("(", "lp").replaceAll(")", "rp").replaceAll("::", "__") + " " + "show");
                        btn.textContent = type;
                        var p = document.createElement("p");
                        p.appendChild(btn);
                        td2.append(p);
                    }
                    tr.append(td1, td2);
                    $("#list").append(tr);
                    $("#list").append("<hr/>")
                }
                for (let i = 0; i < files.length; i++) {
                    const f = files[i];
                    if (f.name.endsWith(".csv")) {
                    } else {
                        var reader = new FileReader();
                        reader.readAsText(f);
                        reader.onload = (function(f){
                            var project = f.name.split("@")[0];
                            return function (event) {
                                var json = JSON.parse(event.target.result);
                                for (let i = 1; i < results.data.length; i++) {
                                    const sample = results.data[i];
                                    if (sample[0] in json) {
                                        var btns = $("." + sample[0].replaceAll(".", "_").replaceAll("(", "lp").replaceAll(")", "rp").replaceAll("::", "__"));
                                        for (let k = 0; k < btns.length; k++) {
                                            const btn = btns[k];
                                            for (let l = 0; l < json[sample[0]].length; l++) {
                                                const state = json[sample[0]][l];
                                                if (state["commitId"] === btn.getAttribute("commit")) {
                                                    for (const key in state) {
                                                        const value = state[key];
                                                        if (Array.isArray(value)) {
                                                            btn.setAttribute("data-" + key, value.join(", "));
                                                        } else {
                                                            if (key != "strippedContent" && !key.startsWith("is") && !key.startsWith("has") && key != "junit3" && key != "commitId") {
                                                                btn.setAttribute("data-" + key, value);
                                                            }
                                                        }
                                                    }
                                                    btn.setAttribute("project", project);
                                                }
                                            }
                                        }
                                    }
                                }
                            };
                        })(f); 
                    }
                }
            }});
            function clearItem() {
                $("#item #name").empty();
                $("#item #filepath").empty();
                $("#item #commit").empty();
                $("#item #liveAnnotations").empty();
                $("#item #COAnnotations").empty();
                $("#item #content").empty();
                $("#item #status").empty();
            }
            $(document).on("click", "button.show", function(e) {
                clearItem();
                var btn = e.currentTarget;
                $("#item #name")[0].textContent = btn.getAttribute("data-name");
                $("#item #filepath")[0].textContent = btn.getAttribute("data-filepath");
                var a = document.createElement("a");
                // console.log(btn);
                a.setAttribute("href", project_repo[btn.getAttribute("project")] + btn.getAttribute("commit"));
                a.setAttribute("target", "_blank");
                a.textContent = btn.getAttribute("commit");
                $("#item #commit")[0].appendChild(a);
                $("#item #liveAnnotations")[0].textContent = btn.getAttribute("data-activeannotations") || "empty";
                $("#item #COAnnotations")[0].textContent = btn.getAttribute("data-coannotations") || "empty";
                var content = document.createElement("xmp");
                content.textContent = btn.getAttribute("data-content");
                $("#item #content")[0].appendChild(content);
                $("#item #status")[0].textContent = btn.getAttribute("data-status");
                $("#item").show();
                $(btn)[0].setAttribute("class", $(btn)[0].getAttribute("class") + " lastclick");
            });
            $("#closeBtn").click(function() {
                $("#item").hide();
            });
        });
        $(document).ready(function() {
            alert("Note: put the manual study file (*.csv) and the 15 json files to a single folder. Click choose files, choose your folder in the popup dialog. Then click start button. All the analysis are at the front end. No files will be uploaded."); 
        });
    </script>
</body>
</html>